<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Emscripten with CMake | Jesse Janzer</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a rel="canonical" href="https://stunlock.gg">home</a></li>
      
      <li><a rel="canonical" href="https://stunlock.gg/posts/">posts</a></li>
      
      <li><a rel="canonical" href="https://stunlock.gg/readme/">readme</a></li>
      
    </ul>
    <hr/>
    </nav>

	<aside>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#example-library">Example Library</a>
      <ul>
        <li><a href="#calccpp">calc.cpp</a></li>
        <li><a href="#calchpp">calc.hpp</a></li>
        <li><a href="#testcpp">test.cpp</a></li>
        <li><a href="#cmakeliststxt">CMakeLists.txt</a></li>
        <li><a href="#building-and-running">Building and Running</a></li>
        <li><a href="#porting">Porting</a></li>
        <li><a href="#option-1---referencing-the-wasm-directly">Option 1 - Referencing the wasm directly</a></li>
        <li><a href="#option-2---referencing-the-js-directly">Option 2 - Referencing the js directly</a></li>
        <li><a href="#optimizing">Optimizing</a></li>
      </ul>
    </li>
    <li><a href="#tldr">TLDR</a></li>
    <li><a href="#minimum-working-example">Minimum Working Example</a>
      <ul>
        <li><a href="#calccpp-1">calc.cpp</a></li>
        <li><a href="#calchpp-1">calc.hpp</a></li>
        <li><a href="#cmakeliststxt-2">CMakeLists.txt</a></li>
        <li><a href="#indexhtml-1">index.html</a></li>
        <li><a href="#buildsh">build.sh</a></li>
      </ul>
    </li>
    <li><a href="#notes-and-quirks">Notes and Quirks</a>
      <ul>
        <li><a href="#without-cmake-or-emscripten">Without CMake or Emscripten</a></li>
        <li><a href="#additional-topics">Additional Topics</a></li>
        <li><a href="#additional-resources">Additional Resources</a></li>
        <li><a href="#c-interface-wrapping">C Interface Wrapping</a></li>
        <li><a href="#emscripten_keepalive">EMSCRIPTEN_KEEPALIVE</a></li>
        <li><a href="#library-building">Library Building</a></li>
        <li><a href="#debugging">Debugging</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </aside>
<div class="article-meta">
 
<h1><span class="title">Emscripten with CMake</span></h1>


<h2 class="date">2022/07/16</h2>
</div>

<main>
<p>TLDR: If you just want a <a href="#tldr">quick solution</a>.</p>
<p>Emscripten is a pretty powerful tool for porting C and C++ to JavaScript. It does this through clang which can compile to WebAssembly, Wasm, and it&rsquo;s own suite of libraries for making things &ldquo;just work&rdquo;. It&rsquo;s fairly straightforward and mostly a drop in replacement for your standard compiler with some exceptions (eg: threads). Dropping it into an existing CMake project, however, isn&rsquo;t as straightforward. I ran into a few quirks that I had trouble finding documented processes online.</p>
<p>There is a working example of a library that compiles both x86_64 and wasm below, along with some notes that you may find helpful.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Make sure you install emscripten first, installation is platform specific. Once you have it installed you will end up with some emscripten folder that you will need to reference for your CMake toolchain or you will need to trigger the <code>emcmake</code> helper instead.</p>
<h2 id="example-library">Example Library</h2>
<p>Let&rsquo;s take an existing static or shared library along with a test executable and convert it so it works for the web.</p>
<h3 id="calccpp">calc.cpp</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">-</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="calchpp">calc.hpp</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="testcpp">test.cpp</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;calc.hpp&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> add(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> sub(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;1+2 =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> a <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;2-1 =&gt; &#34;</span> <span style="color:#f92672">&lt;&lt;</span> b <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(a <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Invalid add&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(b <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Invalid sub&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="cmakeliststxt">CMakeLists.txt</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CMake" data-lang="CMake"><span style="display:flex;"><span>cmake_minimum_required(<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.8</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project(<span style="color:#e6db74">test</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_definitions(<span style="color:#e6db74">-std=c++17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set (<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">#set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS 1) # windows/msvc needs explicit &#34;export all&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>add_library(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">SHARED</span> <span style="color:#e6db74">calc.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#e6db74">test</span> <span style="color:#e6db74">test.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#e6db74">test</span> <span style="color:#e6db74">PUBLIC</span> <span style="color:#e6db74">calc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="building-and-running">Building and Running</h3>
<p>Now we&rsquo;ll build and verify our test executable and calc library exist and work properly</p>
<pre tabindex="0"><code>mkdir build
cd build

cmake cmake ..
cmake --build . --target calc
cmake --build . --target test
</code></pre><p>This will produce both a test executable and a libcalc.so (on linux). Let&rsquo;s make sure our symbols for <code>add</code> and <code>sub</code> are exported properly with <code>objdump</code></p>
<pre tabindex="0"><code>objdump -TC libcalc.so

libcalc.so:     file format elf64-x86-64

DYNAMIC SYMBOL TABLE:
0000000000000000  w   DF *UND*  0000000000000000  GLIBC_2.2.5 __cxa_finalize
0000000000000000  w   D  *UND*  0000000000000000              _ITM_deregisterTMCloneTable
0000000000000000  w   D  *UND*  0000000000000000              __gmon_start__
0000000000000000  w   D  *UND*  0000000000000000              _ITM_registerTMCloneTable
0000000000001100 g    DF .text  0000000000000012  Base        add
0000000000001120 g    DF .text  0000000000000012  Base        sub
</code></pre><p>Great we can see both <code>add</code> and <code>sub</code> in the global symbols and they are defined.</p>
<p>Now let&rsquo;s run our binary <code>test</code> and check the results.</p>
<pre tabindex="0"><code>./test
1+2 =&gt; 3
2-1 =&gt; 1
</code></pre><p>Perfect we have our working executable and library we want to port.</p>
<h3 id="porting">Porting</h3>
<h4 id="invoking-emscripten-with-cmake">Invoking Emscripten with CMake</h4>
<p>We can either call <code>emcmake</code> which will wrap our cmake call with the toolchain file or we can directly specify it with cmake.</p>
<p>If you want to specify <code>-DCMAKE_TOOLCHAIN_FILE</code> yourself, you will need to locate your <code>Emscripten.cmake</code> file which is included with emscripten. In my case I set a PATH variable <code>EMROOT</code> so it points to the emscripten installation folder and then can invoke cmake like so:</p>
<pre tabindex="0"><code>cmake -DCMAKE_TOOLCHAIN_FILE=$EMROOT/cmake/Modules/Platform/Emscripten.cmake ..
</code></pre><p>Our other option (the easier one) is to just add <code>emcmake</code> before our cmake call like so:</p>
<pre tabindex="0"><code>emcmake cmake ..
</code></pre><p>We can then just call our normal make/cmake calls without wrapping them.</p>
<pre tabindex="0"><code>cmake --build . --target calc
cmake --build . --target test
</code></pre><p>Let&rsquo;s see what happens if we just stop here, does this work?</p>
<pre tabindex="0"><code>mkdir build.em
cd build.em

emcmake cmake ..
cmake --build . --target calc
cmake --build . --target test
</code></pre><p>This produces a few files</p>
<ol>
<li>libcalc.a</li>
<li>test.js</li>
<li>test.wasm</li>
</ol>
<p>We&rsquo;ll make a simple web page and host it pointing to the test.js that cmake and emscripten made for us.</p>
<h4 id="indexhtml">index.html</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Simple template&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;build.em/test.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>If we point to this page and load it, checking the developer console we can indeed see output:</p>
<pre tabindex="0"><code>test.js:2128 1+2 =&gt; 3
test.js:2128 2-1 =&gt; 1
</code></pre><p>We can also see that we can call <code>Module._main()</code> from the console which will re-run our program:</p>
<pre tabindex="0"><code>Module._main()
test.js:2128 1+2 =&gt; 3
test.js:2128 2-1 =&gt; 1
0
</code></pre><p>Neat, well that would be where we&rsquo;d stop if we just want to run an executable, but we want to be able to use the calc library and call our <code>add</code> and <code>sub</code> functions ourselves, so how do we do that? We don&rsquo;t see a <code>Module._add</code> or similar functions in the object.</p>
<p>This is where it gets a bit harder, that test.js file was produced for us and handles all of the instantiation for us.</p>
<p>Let&rsquo;s take a look at that <code>libcalc.a</code> archive file. If we open it up with <code>ar x libcalc.a</code> it will produec a <code>calc.cpp.o</code> object file but it&rsquo;s really a wasm file. We can inspect it using <code>wasm-objdump</code> (see below):</p>
<pre tabindex="0"><code>ar x libcalc.a
wasm-objdump -x calc.cpp.o

calc.cpp.o:     file format wasm 0x1

Section Details:

Type[1]:
 - type[0] (i32, i32) -&gt; i32
Import[2]:
 - memory[0] pages: initial=0 &lt;- env.__linear_memory
 - global[0] i32 mutable=1 &lt;- env.__stack_pointer
Function[2]:
 - func[0] sig=0 &lt;add&gt;
 - func[1] sig=0 &lt;sub&gt;
Code[2]:
 - func[0] size=61 &lt;add&gt;
 - func[1] size=61 &lt;sub&gt;
Custom:
 - name: &#34;linking&#34;
  - symbol table [count=3]
   - 0: F &lt;add&gt; func=0 binding=global vis=default
   - 1: G &lt;env.__stack_pointer&gt; global=0 undefined binding=global vis=default
   - 2: F &lt;sub&gt; func=1 binding=global vis=default
Custom:
 - name: &#34;reloc.CODE&#34;
  - relocations for section: 3 (Code) [2]
   - R_WASM_GLOBAL_INDEX_LEB offset=0x000006(file=0x00005f) symbol=1 &lt;env.__stack_pointer&gt;
   - R_WASM_GLOBAL_INDEX_LEB offset=0x000044(file=0x00009d) symbol=1 &lt;env.__stack_pointer&gt;
Custom:
 - name: &#34;producers&#34;
</code></pre><p>It does indeed expose the add and sub functions. There is a problem though in that in the <code>Import</code> section it needs <code>__linear_memory</code> and <code>__stack_pointer</code>. This will be a problem but we can define these when loading directly through WebAssembly API. There is one other concern which is that the <code>Export</code> section doesn&rsquo;t provide any definitions. Let&rsquo;s try to load our wasm file directly though, by creating a new html file. We&rsquo;ll copy calc.cpp.o to calc.wasm, then produce this stub html.</p>
<h4 id="wasmhtml">wasm.html</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Simple template&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">importObject</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">env</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">__linear_memory</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({ <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">256</span> }),
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">__stack_pointer</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Global</span>({<span style="color:#a6e22e">value</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;i32&#39;</span>, <span style="color:#a6e22e">mutable</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>,}, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiateStreaming</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;build.em/calc.wasm&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">importObject</span>
</span></span><span style="display:flex;"><span>      ).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">add</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">add</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sub</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">sub</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">sub</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>Running this in a browser we get this error in the console:</p>
<pre tabindex="0"><code>wasm.html:24 Uncaught (in promise) TypeError: add is not a function
    at wasm.html:24:21
</code></pre><p>Looks like we need to export these functions in some way, at this point we&rsquo;re going to need to modify our <code>CMakeLists.txt</code> now.</p>
<h4 id="modifying-your-cmakeliststxt">Modifying Your CMakeLists.txt</h4>
<p>The easiest way of making this work is converting your <code>add_library</code> call to an <code>add_executable</code>. Let&rsquo;s try that now and take a look at what it produces.</p>
<p>We&rsquo;ll change</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CMake" data-lang="CMake"><span style="display:flex;"><span>add_library(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">SHARED</span> <span style="color:#e6db74">calc.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>to</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CMake" data-lang="CMake"><span style="display:flex;"><span>add_executable(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">calc.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Since we no longer need the test app either we can comment that out for now <code>#add_executable(test test.cpp)</code>. After rebuilding we&rsquo;ll see both a <code>calc.js</code> and a <code>calc.wasm</code> file. Let&rsquo;s take a look at the wasm file first.</p>
<pre tabindex="0"><code>wasm-objdump -x calc.wasm

calc.wasm:      file format wasm 0x1

Section Details:

Type[7]:
 - type[0] () -&gt; i32
 - type[1] (i32) -&gt; nil
 - type[2] () -&gt; nil
 - type[3] (i32) -&gt; i32
 - type[4] (i32, i32) -&gt; i32
 - type[5] (i32, i32, i32) -&gt; i32
 - type[6] (i32, i64, i32) -&gt; i64
Function[18]:
 - func[0] sig=2 &lt;__wasm_call_ctors&gt;
 - func[1] sig=4 &lt;add&gt;
 - func[2] sig=4 &lt;sub&gt;
 - func[3] sig=0 &lt;stackSave&gt;
 - func[4] sig=1 &lt;stackRestore&gt;
 - func[5] sig=3 &lt;stackAlloc&gt;
 - func[6] sig=2 &lt;emscripten_stack_init&gt;
 - func[7] sig=0 &lt;emscripten_stack_get_free&gt;
 - func[8] sig=0 &lt;emscripten_stack_get_base&gt;
 - func[9] sig=0 &lt;emscripten_stack_get_end&gt;
 - func[10] sig=1
 - func[11] sig=1
 - func[12] sig=0
 - func[13] sig=2
 - func[14] sig=3
 - func[15] sig=1
 - func[16] sig=3 &lt;fflush&gt;
 - func[17] sig=0 &lt;__errno_location&gt;
Table[1]:
 - table[0] type=funcref initial=1 max=1
Memory[1]:
 - memory[0] pages: initial=256 max=256
Global[3]:
 - global[0] i32 mutable=1 - init i32=5243920
 - global[1] i32 mutable=1 - init i32=0
 - global[2] i32 mutable=1 - init i32=0
Export[14]:
 - memory[0] -&gt; &#34;memory&#34;
 - func[0] &lt;__wasm_call_ctors&gt; -&gt; &#34;__wasm_call_ctors&#34;
 - func[1] &lt;add&gt; -&gt; &#34;add&#34;
 - func[2] &lt;sub&gt; -&gt; &#34;sub&#34;
 - table[0] -&gt; &#34;__indirect_function_table&#34;
 - func[17] &lt;__errno_location&gt; -&gt; &#34;__errno_location&#34;
 - func[16] &lt;fflush&gt; -&gt; &#34;fflush&#34;
 - func[6] &lt;emscripten_stack_init&gt; -&gt; &#34;emscripten_stack_init&#34;
 - func[7] &lt;emscripten_stack_get_free&gt; -&gt; &#34;emscripten_stack_get_free&#34;
 - func[8] &lt;emscripten_stack_get_base&gt; -&gt; &#34;emscripten_stack_get_base&#34;
 - func[9] &lt;emscripten_stack_get_end&gt; -&gt; &#34;emscripten_stack_get_end&#34;
 - func[3] &lt;stackSave&gt; -&gt; &#34;stackSave&#34;
 - func[4] &lt;stackRestore&gt; -&gt; &#34;stackRestore&#34;
 - func[5] &lt;stackAlloc&gt; -&gt; &#34;stackAlloc&#34;
Code[18]:
 - func[0] size=4 &lt;__wasm_call_ctors&gt;
 - func[1] size=57 &lt;add&gt;
 - func[2] size=57 &lt;sub&gt;
 - func[3] size=4 &lt;stackSave&gt;
 - func[4] size=6 &lt;stackRestore&gt;
 - func[5] size=18 &lt;stackAlloc&gt;
 - func[6] size=20 &lt;emscripten_stack_init&gt;
 - func[7] size=7 &lt;emscripten_stack_get_free&gt;
 - func[8] size=4 &lt;emscripten_stack_get_base&gt;
 - func[9] size=4 &lt;emscripten_stack_get_end&gt;
 - func[10] size=2
 - func[11] size=2
 - func[12] size=10
 - func[13] size=7
 - func[14] size=4
 - func[15] size=2
 - func[16] size=304 &lt;fflush&gt;
 - func[17] size=5 &lt;__errno_location&gt;
</code></pre><p>That&rsquo;s a ton of extra stuff from before, but the important parts are both <code>add</code> and <code>sub</code> are both in the <code>Function</code> and <code>Export</code> section. Let&rsquo;s try this in our html file now and see if we can get this to work. Since we produced both a <code>.js</code> and <code>.wasm</code> file we can reference either.</p>
<h3 id="option-1---referencing-the-wasm-directly">Option 1 - Referencing the wasm directly</h3>
<p>Since we no longer have required <code>Import</code> sections, we can remove our environment importObject options.</p>
<h4 id="wasmhtml-1">wasm.html</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Simple template&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiateStreaming</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;build.em/calc.wasm&#39;</span>),
</span></span><span style="display:flex;"><span>      ).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">add</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">add</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sub</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">sub</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">sub</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>Looking at our console log, it produces the following output:</p>
<pre tabindex="0"><code>wasm.html:24 3
wasm.html:25 1
</code></pre><p>Now we have a working library we can call from our browser.</p>
<h3 id="option-2---referencing-the-js-directly">Option 2 - Referencing the js directly</h3>
<p>Since we also produced a JavaScript file, we can reference that instead. However we&rsquo;ll need to change how we invoke our functions. We&rsquo;ll be calling into the <code>Module</code> object, in addition we&rsquo;ll need to wait for Module to finish loading as well. Note the necessary &ldquo;_&rdquo; underscore prefix here.</p>
<h4 id="wasmhtml-2">wasm.html</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Simple template&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;build.em/calc.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Module</span>.<span style="color:#a6e22e">onRuntimeInitialized</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">Module</span>.<span style="color:#a6e22e">_add</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">Module</span>.<span style="color:#a6e22e">_sub</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>This also produces the correct output:</p>
<pre tabindex="0"><code>(wasm.html):12 3
(wasm.html):13 1
</code></pre><p>There are several options you can take on loading/deferring/etc your scripts. My personal preference is to reference the <code>wasm</code> file directly via the <code>WebAssembly.instantiateStreaming</code> call since I have complete control over success or failure states and order guarantees.</p>
<h3 id="optimizing">Optimizing</h3>
<p>While our working example does indeed work, there are many options we can pass in to adjust what get&rsquo;s built. By default our wasm file is built with <code>-O0</code> meaning no optimizations. Let&rsquo;s drop in a few arguments to help reduce unnecessary exports and optimizations now.</p>
<h4 id="cmakeliststxt-1">CMakeLists.txt</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CMake" data-lang="CMake"><span style="display:flex;"><span>cmake_minimum_required(<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.8</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project(<span style="color:#e6db74">test</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_definitions(<span style="color:#e6db74">-std=c++17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set (<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if (<span style="color:#e6db74">DEFINED</span> <span style="color:#e6db74">EMSCRIPTEN</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	add_executable(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">calc.cpp</span> <span style="color:#e6db74">calc.hpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set(<span style="color:#e6db74">CMAKE_EXECUTABLE_SUFFIX</span> <span style="color:#e6db74">&#34;.wasm&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set_target_properties(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">COMPILE_FLAGS</span> <span style="color:#e6db74">&#34;-Os -s SIDE_MODULE=1 &#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set_target_properties(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">LINK_FLAGS</span>    <span style="color:#e6db74">&#34;-Os -s WASM=1 -s SIDE_MODULE=1 -s STANDALONE_WASM --no-entry&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	add_library(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">SHARED</span> <span style="color:#e6db74">calc.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Let&rsquo;s look at the options we set to explain what they&rsquo;re doing</p>
<ol>
<li><code>-Os</code><br>
Specifies that we want optimizations and code size reductions (very useful for web). These are pretty much the same things as traditional optimization flags in gcc/clang.</li>
<li><code>-s WASM=1</code><br>
This is the default value, but doesn&rsquo;t hurt to set. Values can be 0, 1, or 2. Where 0 means compile to JavaScript, 1 means compile to WebAssembly, and 2 means compile to both.</li>
<li><code>-s SIDE_MODULE=1</code><br>
If we set this to 2 we&rsquo;ll remove functions that don&rsquo;t have <code>EMSCRIPTEN_KEEPALIVE</code> macros in their definitions (ie: calc.cpp). This defaults to 0, by specifying 1 here it removes many additional entries in the wasm library that we don&rsquo;t currently need.</li>
<li><code>-s STANDALONE_WASM</code><br>
Specifies that we want to build a WebAssembly file that doesn&rsquo;t need a supporting JavaScript file to run. Normally we would need a main entry point, so we also include the <code>--no-entry</code> flag as well.</li>
<li><code>--no-entry</code><br>
Specifies that we&rsquo;re not using a main entry point in our code (ie: no <code>int main(...)</code>).</li>
<li><code>set(CMAKE_EXECUTABLE_SUFFIX &quot;.wasm&quot;)</code><br>
Tells CMake and Emscripten to produce a wasm file instead of defaulting to a javascript one</li>
</ol>
<h2 id="tldr">TLDR</h2>
<p>The easiest solution is to convert your <code>add_library</code> call to an <code>add_executable</code> call, this will produce a <code>.js</code> or <code>.wasm</code> file that you can directly load in a browser.</p>
<h2 id="minimum-working-example">Minimum Working Example</h2>
<p>In summary if you want to reference the working example files, see below:</p>
<h3 id="calccpp-1">calc.cpp</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#ifdef __EMSCRIPTEN__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;emscripten/emscripten.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EMSCRIPTEN_KEEPALIVE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    EMSCRIPTEN_KEEPALIVE <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    EMSCRIPTEN_KEEPALIVE <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">-</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="calchpp-1">calc.hpp</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="cmakeliststxt-2">CMakeLists.txt</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-CMake" data-lang="CMake"><span style="display:flex;"><span>cmake_minimum_required(<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.8</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project(<span style="color:#e6db74">test</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_definitions(<span style="color:#e6db74">-std=c++17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set (<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">17</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>if (<span style="color:#e6db74">DEFINED</span> <span style="color:#e6db74">EMSCRIPTEN</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	add_executable(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">calc.cpp</span> <span style="color:#e6db74">calc.hpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set(<span style="color:#e6db74">CMAKE_EXECUTABLE_SUFFIX</span> <span style="color:#e6db74">&#34;.wasm&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set_target_properties(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">COMPILE_FLAGS</span> <span style="color:#e6db74">&#34;-Os -s SIDE_MODULE=1 &#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	set_target_properties(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">PROPERTIES</span> <span style="color:#e6db74">LINK_FLAGS</span>    <span style="color:#e6db74">&#34;-Os -s WASM=1 -s SIDE_MODULE=1 -s STANDALONE_WASM --no-entry&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>else()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	add_library(<span style="color:#e6db74">calc</span> <span style="color:#e6db74">SHARED</span> <span style="color:#e6db74">calc.cpp</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="indexhtml-1">index.html</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">meta</span> <span style="color:#a6e22e">charset</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">title</span>&gt;Calculator Test&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiateStreaming</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;build.em/calc.wasm&#39;</span>),
</span></span><span style="display:flex;"><span>      ).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">add</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">add</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sub</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">sub</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">add</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">sub</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><h3 id="buildsh">build.sh</h3>
<p>A simple build script from the CLI</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e"># Either set EMROOT to your emscripten root folder, or ensure emscripten is setup in your path</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You can trip the emsdk/emsdk_env.sh via or set in your .bash_profile or similar</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  source &#34;...path_to_emscripten.../emsdk/emsdk_env.sh&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#cmake -DCMAKE_TOOLCHAIN_FILE=$EMROOT/cmake/Modules/Platform/Emscripten.cmake ..</span>
</span></span><span style="display:flex;"><span>emcmake cmake ..
</span></span><span style="display:flex;"><span>cmake --build . --target calc
</span></span></code></pre></div><h2 id="notes-and-quirks">Notes and Quirks</h2>
<h3 id="without-cmake-or-emscripten">Without CMake or Emscripten</h3>
<p>If you want to compile without CMake, it&rsquo;s quite simple, we can build via:</p>
<pre tabindex="0"><code>mkdir build
cd build

clang++ -Wall -shared ../calc.cpp -o libcalc.so
clang++ -Wall ../test.cpp -I ../calc.hpp ./libcalc.so -o test
</code></pre><p>This will produce both a libcalc.so and test files. We can then make sure it&rsquo;s linking properly via <code>ldd test</code></p>
<pre tabindex="0"><code>ldd test
        linux-vdso.so.1 (0x00007ffe3c874000)
        ./libcalc.so (0x00007fc4dda17000)
        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007fc4dd82c000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007fc4dd6dd000)
        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007fc4dd6c2000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fc4dd4d0000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc4dda1e000)
</code></pre><p>And running <code>./test</code> produces the result we&rsquo;re looking for</p>
<pre tabindex="0"><code>./test
1+2 =&gt; 3
2-1 =&gt; 1
</code></pre><h3 id="additional-topics">Additional Topics</h3>
<p>If you are looking to better fine tune your results, here are some topics that you&rsquo;ll want to look at.</p>
<ol>
<li>ccal, cwrap, EXPORTED_RUNTIME_METHODS<br>
<a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#interacting-with-code-ccall-cwrap">https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#interacting-with-code-ccall-cwrap</a></li>
<li>lld WebAssembly Options - explains things like <code>--no-entry</code>, <code>--export-all</code> and other options<br>
<a href="https://lld.llvm.org/WebAssembly.html">https://lld.llvm.org/WebAssembly.html</a></li>
<li>emcc options<br>
<a href="https://emscripten.org/docs/tools_reference/emcc.html">https://emscripten.org/docs/tools_reference/emcc.html</a></li>
<li>emcc settings.json - explain this like <code>SIDE_MODULE</code> vs <code>MAIN_MODULE</code> and other options that can be used at compile and link time<br>
<a href="https://github.com/emscripten-core/emscripten/blob/main/src/settings.js">https://github.com/emscripten-core/emscripten/blob/main/src/settings.js</a></li>
<li>emscripten api - programming interace options such as <code>EMSCRIPTEN_KEEPALIVE</code>
<a href="https://emscripten.org/docs/api_reference/emscripten.h.html">https://emscripten.org/docs/api_reference/emscripten.h.html</a></li>
</ol>
<h3 id="additional-resources">Additional Resources</h3>
<ol>
<li><a href="https://surma.dev/things/c-to-webassembly/">https://surma.dev/things/c-to-webassembly/</a></li>
<li><a href="https://users.rust-lang.org/t/wasm-unknown-vs-emscripten/22997/4">https://users.rust-lang.org/t/wasm-unknown-vs-emscripten/22997/4</a></li>
<li><a href="https://stackoverflow.com/questions/64690937/what-is-the-difference-between-emscripten-and-clang-in-terms-of-webassembly-comp">https://stackoverflow.com/questions/64690937/what-is-the-difference-between-emscripten-and-clang-in-terms-of-webassembly-comp</a></li>
<li><a href="https://depth-first.com/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/">https://depth-first.com/articles/2019/10/16/compiling-c-to-webassembly-and-running-it-without-emscripten/</a></li>
<li><a href="https://github.com/WebAssembly/wasi-sdk">https://github.com/WebAssembly/wasi-sdk</a></li>
<li><a href="https://reviews.llvm.org/D34172?id=102407">https://reviews.llvm.org/D34172?id=102407</a></li>
<li><a href="https://blog.meain.io/2017/ehh-webassembly/">https://blog.meain.io/2017/ehh-webassembly/</a></li>
</ol>
<h3 id="c-interface-wrapping">C Interface Wrapping</h3>
<p>Just FYI, we want to wrap any C++ functions with <code>extern &quot;C&quot;</code> to prevent name mangling. This is common in many C++ libraries which provide a C interface anyway and it is quite common in bespoke libraries.</p>
<h3 id="emscripten_keepalive">EMSCRIPTEN_KEEPALIVE</h3>
<p>This eliminates the need to specify the functions you want to export in your flags when <code>MAIN_MODULE</code> or <code>SIDE_MODULE</code> is set at a value or 2. This is very helpful if you want to remove other code in your library that you don&rsquo;t plan to expose for Wasm.</p>
<p>For example we could modify our calc.cpp file as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#75715e">#ifdef __EMSCRIPTEN__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;emscripten/emscripten.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define EMSCRIPTEN_KEEPALIVE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#e6db74">&#34;C&#34;</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    EMSCRIPTEN_KEEPALIVE <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    EMSCRIPTEN_KEEPALIVE <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sub</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> a <span style="color:#f92672">-</span> b;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="library-building">Library Building</h3>
<p>When building a library via <code>add_library</code> your wasm will be inside an archive file, you can extract it via <code>ar -x your_file.a</code> which will extact the wasm files with <code>.o</code> object suffixes. You can then just rename or load these directly if you wish. If you want to skip this process you can just cheat and swap your <code>add_library</code> into an <code>add_executable</code>, this is easily done with a if check for <code>if (DEFINED EMSCRIPTEN)</code> and branch in your cmake.</p>
<h3 id="debugging">Debugging</h3>
<p>Install the <code>wabt</code> tools, this gives you access to tools like <code>wasm-objdump</code> which are very helpful in debugging which functions you&rsquo;ve exported and provided code for.</p>
<p>Running objdump against our calc library wasm</p>
<pre tabindex="0"><code>wasm-objdump -x calc.wasm

calc.wasm:      file format wasm 0x1

Section Details:

Custom:
 - name: &#34;dylink.0&#34;
Type[2]:
 - type[0] (i32, i32) -&gt; i32
 - type[1] () -&gt; nil
Function[3]:
 - func[0] sig=1 &lt;__wasm_apply_data_relocs&gt;
 - func[1] sig=0 &lt;add&gt;
 - func[2] sig=0 &lt;sub&gt;
Export[4]:
 - func[0] &lt;__wasm_apply_data_relocs&gt; -&gt; &#34;__wasm_call_ctors&#34;
 - func[0] &lt;__wasm_apply_data_relocs&gt; -&gt; &#34;__wasm_apply_data_relocs&#34;
 - func[1] &lt;add&gt; -&gt; &#34;add&#34;
 - func[2] &lt;sub&gt; -&gt; &#34;sub&#34;
Code[3]:
 - func[0] size=3 &lt;__wasm_apply_data_relocs&gt;
 - func[1] size=7 &lt;add&gt;
 - func[2] size=7 &lt;sub&gt;
</code></pre><p>You can clearly see the <code>add</code> and <code>sub</code> functions exported and defined in the wasm.</p>

</main>

  <footer>
  
  
  </footer>
  
  
  </body>
</html>

